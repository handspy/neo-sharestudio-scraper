<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <title>ShareStudio URL Data Extraction</title>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="description" content="" />

  <link rel="icon" href="favicon.png">

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script type="module" src="dist/neo-sharestudio-scraper.esm.js"></script>
  <script type="text/javascript">
    async function downloadHsJSON() {
      const urlStr = document.querySelector('input[name="url"]').value;

      let id;
      if (urlStr.startsWith('https://sharestudio.web.app')) {
        const url = new URL(urlStr);
        id = url.searchParams.get('id');
      } else {
        id = urlStr;
      }
      
      const data = await fetchNeoPages(id);
      console.log(data);
      
      const json = JSON.stringify(data);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function downloadCSV() {
      var url = document.querySelector('input[name="url"]').value;
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.responseType = "json";
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          var data = xhr.response;
          var csv = "data:text/csv;charset=utf-8,";
          csv += "Time,Player,Action,Target,Card,Location,Amount,Result\n";
          data.forEach(function (row) {
            csv += row.time + "," + row.player + "," + row.action + "," + row.target + "," + row.card + "," + row.location + "," + row.amount + "," + row.result + "\n";
          });
          var blob = new Blob([csv], { type: "text/csv" });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'data.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
        } else {
          console.error("Failed to download data");
        }
      };
      xhr.send();
    }
  </script>
</head>

<body>

  <h1>ShareStudio URL Data Extraction</h1>

  <form action="#">

    <label for="url">ShareStudio URL:</label><br>

    <input type="text" name="url" placeholder="https://sharestudio.web.app/?id=XXX"><br>

    <input type="submit" value="Download HandSpy Format" onclick="downloadHsJSON()">
    <input type="submit" value="Download CSV" onclick="downloadCSV()">

  </form>

</body>

</html>